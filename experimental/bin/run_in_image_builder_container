#!/bin/bash

RUN_THIS_SCRIPT_PATH="$1"

export DOCKER_MAP_DIR="/mnt/working"

RUN_THIS_SCRIPT_PATH_IN_DOCKER="$(echo $RUN_THIS_SCRIPT_PATH | sed "s~$PWD~$DOCKER_MAP_DIR~" )"

for docker_command in stop rm; do
    docker $docker_command image_builder_container 2> /dev/null
done

IMAGE_BUILDER_IMAGE="broadinstitute/image_builder_image:latest"
DOCKER_RUN_FLAGS="-it --rm"
docker run --name image_builder_container \
    $DOCKER_RUN_FLAGS \
    -e DOCKER_MAP_DIR \
    -v $PWD:$DOCKER_MAP_DIR \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -a stdout -a stderr \
    "$IMAGE_BUILDER_IMAGE" \
    $RUN_THIS_SCRIPT_PATH_IN_DOCKER \
    || { docker_exit_value="$?"; echo "ERROR: $(basename $0): $RUN_THIS_SCRIPT_PATH_IN_DOCKER FAILED to run in image builder container, docker run failed with $docker_exit_value" >&2; exit 1; }
